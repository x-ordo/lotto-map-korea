const fs = require('fs');
const path = require('path');
const { parse } = require('csv-parse/sync');
const iconv = require('iconv-lite');

const KAKAO_API_KEY = '3963628c7ec36ed00dbbfc8fd990c882';
const CACHE_PATH = path.join(__dirname, '../data/geoCache.json');
const CONCURRENCY_LIMIT = 10; // 동시 요청 수 제한
const RETRY_LIMIT = 2;

// 캐시 로드
let geoCache = {};
if (fs.existsSync(CACHE_PATH)) {
    try {
        geoCache = JSON.parse(fs.readFileSync(CACHE_PATH, 'utf8'));
    } catch (e) {
        console.error('Failed to load cache:', e);
    }
}

function saveCache() {
    fs.writeFileSync(CACHE_PATH, JSON.stringify(geoCache, null, 2));
}

// 주소 정규화 알고리즘
function normalizeAddress(addr) {
    if (!addr) return '';
    // 1. 괄호 안 내용 제거 (예: (정왕동, 정일빌딩))
    let cleaned = addr.replace(/\(.*\)/g, '');
    // 2. 불필요한 상세 주소 키워드 제거
    cleaned = cleaned.replace(/(층|호|번지).*$/, '');
    // 3. 연속된 공백 제거
    return cleaned.trim();
}

async function geocode(address, retryCount = 0) {
    const normalized = normalizeAddress(address);
    if (!normalized) return null;

    // 1. 캐시 확인
    if (geoCache[normalized]) {
        return geoCache[normalized];
    }

    try {
        const url = `https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(normalized)}`;
        const response = await fetch(url, {
            headers: { Authorization: `KakaoAK ${KAKAO_API_KEY}` }
        });

        const data = await response.json();
        if (data.documents && data.documents.length > 0) {
            const result = {
                lat: parseFloat(data.documents[0].y),
                lng: parseFloat(data.documents[0].x)
            };
            // 캐시에 저장
            geoCache[normalized] = result;
            return result;
        } else {
            console.log(`No results for: "${normalized}" (Original: "${address}")`);
        }
        
        // 검색 실패 시 주소를 더 단순화해서 재시도 (알고리즘 튜닝)
        const simplified = normalized.split(' ').slice(0, -1).join(' ');
        if (simplified.length > 5 && retryCount === 0) {
            return geocode(simplified, 1);
        }

    } catch (error) {
        console.error(`Error geocoding ${normalized}:`, error.message);
    }
    return null;
}

// 배치 처리 함수
async function processBatch(items, batchSize) {
    const results = [];
    for (let i = 0; i < items.length; i += batchSize) {
        const batch = items.slice(i, i + batchSize);
        console.log(`Processing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(items.length/batchSize)}...`);
        const batchResults = await Promise.all(batch.map(item => item()));
        results.push(...batchResults);
        
        // 각 배치 사이에 미세한 지연 (API 보호)
        await new Promise(r => setTimeout(r, 100));
        
        // 중간중간 캐시 저장
        if (i % (batchSize * 5) === 0) saveCache();
    }
    return results;
}

async function main() {
    console.log('Starting optimized geocoding...');
    
    const manualData = `종합복권슈퍼,경기 시흥시 마유로 336,경기 시흥시 정왕동 1735-2번지,1등 당첨: 3회,3
부일카서비스,부산 동구 자성로133번길 35,부산 동구 범일동 830-195번지,1등 당첨: 3회,3
오천억복권방,광주 서구 상무대로 1087,광주 서구 화정동 782-14번지,1등 당첨: 3회,3
한꿈복권방,울산 중구 번영로 586,울산 중구 남외동 486-5,1등 당첨: 3회,3
로또명당해미점,충남 서산시 남문2로 108 ,충남 서산시 해미면 읍내리 295-4,1등 당첨: 2회,2
복권세상,전남 목포시 청호로 139 ,전남 목포시 산정동 1693-4,1등 당첨: 2회,2
행운복권,전남 무안군 영산로 1693,전남 무안군 청계면 도림리 467-1,1등 당첨: 2회,2
복권명당,경북 경산시 경안로 214,경북 경산시 중방동 848-9번지,1등 당첨: 2회,2
NG24,경북 칠곡군 석적읍 북중리3길 59,경북 칠곡군 석적읍 중리 86-8번지,1등 당첨: 2회,2
로또복권 포항IC점,경북 포항시 북구 새마을로 340 ,경북 포항시 북구 흥해읍 대련리 328-4,1등 당첨: 2회,2
알리바이,광주 광산구 수등로 253,광주 광산구 신가동 986-4번지,1등 당첨: 2회,2
대광복권방,전남 화순군 칠충로 55 대광로제비앙,전남 화순군 화순읍 대리 97-3,1등 당첨: 2회,2
금두꺼비복권방,경기 고양시 일산서구 강성로 263,경기 고양시 일산서구 대화동 2208번지,1등 당첨: 2회,2
로또명당인주점,충남 아산시 서해로 519-2 ,충남 아산시 인주면 신성리 430-2,1등 당첨: 2회,2
NBA(엔비에이),인천 중구 신도시남로142번길 6,인천 중구 운서동 2803-1,1등 당첨: 2회,2
흥양마중물,강원 원주시 치악로 2335 ,강원 원주시 소초면 흥양리 1718-4,1등 당첨: 2회,2
황금복권방,강원 원주시 봉화로 74,강원 원주시 단계동 808,1등 당첨: 2회,2
로또복권두정점,충남 천안시 서북구 두정로 251,충남 천안시 서북구 두정동 153-1번지,1등 당첨: 2회,2
진평양행,강원 강릉시 임영로 107,강원 강릉시 남문동 7-12번지,1등 당첨: 2회,2
주택복권방,강원 원주시 우산초교길 29 ,강원 원주시 우산동 232-2,1등 당첨: 2회,2
복권세상,전남 목포시 영산로270번길 2,전남 목포시 용당2동 960-108번지,1등 당첨: 2회,2
베스트올수성점,전북 정읍시 수성2로 28 영화마을 VIDEO,전북 정읍시 수성동 932-1,1등 당첨: 2회,2
당하복권명당,인천 서구 서곶로 788 홀리랜드,인천 서구 당하동 1098-5,1등 당첨: 2회,2
우리로또,경기 의정부시 새말로 7 ,경기 의정부시 신곡동 757-5,1등 당첨: 2회,2
행복한사람들 (흥부네),경기 광주시 경충대로 746,경기 광주시 곤지암읍 삼리 105-2,1등 당첨: 2회,2
대박천하마트,인천 부평구 굴포로 48,인천 부평구 갈산동 367번지,1등 당첨: 2회,2
패밀리복권방,경기 남양주시 늘을1로16번길 29,경기 남양주시 호평동 638-1,1등 당첨: 2회,2
대길복권,경기 수원시 장안구 서부로 2129-1,경기 수원시 장안구 율전동 291,1등 당첨: 2회,2
나눔로또한대점,경기 안산시 상록구 중보로 57 한양대프라자,경기 안산시 상록구 이동 716,1등 당첨: 2회,2
일등복권,경기 양주시 송랑로 223,경기 양주시 삼숭동 672-5번지,1등 당첨: 2회,2
복권,경기 의정부시 태평로 75 ,경기 의정부시 의정부동 148-10,1등 당첨: 2회,2
세븐일레븐 홍익점,경기 안성시 종합운동장로 161,경기 안성시 보개면 양복리 150-1,1등 당첨: 2회,2
대전우표사,대전 동구 중앙로204번길 16-1,대전 동구 중동 88-3번지,1등 당첨: 2회,2
롯데무역,부산 영도구 꿈나무길 197 ,부산 영도구 영선동2가 197-2,1등 당첨: 2회,2
복권나라,서울 관악구 남부순환로 1739-9 ,서울 관악구 봉천동 926-25,1등 당첨: 2회,2
복권나라,서울 관악구 은천로 40-1 ,서울 관악구 봉천동 941-18,1등 당첨: 2회,2
복권나라,서울 관악구 장군봉2길 11 ,서울 관악구 봉천동 946-15,1등 당첨: 2회,2
그랜드마트앞가판점,서울 마포구 신촌로 94,서울 마포구 노고산동 57-2번지,1등 당첨: 2회,2
제이복권방,서울 종로구 종로 225-1,서울 종로구 종로5가 58번지,1등 당첨: 2회,2
일동복권판매점,경기 포천시 화동로 1081,경기 포천시 일동면 기산리 92-1,1등 당첨: 1회,1
한빛3단지 천지인,경기 파주시 와석순환로 66,경기 파주시 야당동 1006-8,1등 당첨: 1회,1
대박행진 복권랜드,경기 파주시 금빛로 22,경기 파주시 금촌동 989-1번지,1등 당첨: 1회,1
용이복권방,경기 평택시 현신3길 44 ,경기 평택시 용이동 450-6,1등 당첨: 1회,1
프랜드편의점,경기 화성시 3.1만세로 1100-2 ,경기 화성시 향남읍 평리 109-6,1등 당첨: 1회,1
성강동인,경기 하남시 신장로 212,경기 하남시 덕풍동 342-31,1등 당첨: 1회,1
이제이,경기 화성시 동탄산척로2나길 4-12 ,경기 화성시 산척동 711-2,1등 당첨: 1회,1
스피드세븐,경기 화성시 한절이길 15,경기 화성시 향남읍 하길리 1457-1,1등 당첨: 1회,1
대소원로또,충북 충주시 대소원면 중원대로 4373,충북 충주시 이류면 대소리 53-3번지,1등 당첨: 1회,1
자매점,경기 파주시 문화로 95,경기 파주시 금촌동 62-6,1등 당첨: 1회,1
천금복권방,충북 청주시 상당구 쇠내로 150-1,충북 청주시 상당구 영운동 55-1번지,1등 당첨: 1회,1
비엠복권,충북 청주시 흥덕구 대신로 108 청주테크노밸리,충북 청주시 흥덕구 송정동 292-13,1등 당첨: 1회,1
썬마트,충북 청주시 흥덕구 진재로23번길 25,충북 청주시 흥덕구 복대동 2719번지,1등 당첨: 1회,1
드림복권방,충북 청주시 흥덕구 내수동로42번길 4,충북 청주시 흥덕구 복대동 1623,1등 당첨: 1회,1
오사랑복권,충북 청주시 흥덕구 진재로 42,충북 청주시 흥덕구 복대동 2957,1등 당첨: 1회,1
행복복권방,충북 청주시 흥덕구 풍년로 26 명인투플러스,충북 청주시 흥덕구 가경동 1685,1등 당첨: 1회,1
로또스튜디오,충북 청주시 청원구 사뜸로 48-1 동성교회,충북 청주시 청원구 율량동 1410,1등 당첨: 1회,1
일등복권방,충북 청주시 서원구 매봉로 26-1,충북 청주시 서원구 분평동 274,1등 당첨: 1회,1
복권명당,충북 청주시 상당구 월평로 204,충북 청주시 상당구 용암동 1841,1등 당첨: 1회,1
럭키로또복권판매점,충북 청주시 상당구 무농정로 10-1 ,충북 청주시 상당구 용암동 1763,1등 당첨: 1회,1
로또1등판매점,경기 화성시 병점중앙로170번길 2,경기 화성시 진안동 873-1,1등 당첨: 1회,1
로또1등판매점,경기 화성시 초록로 20-3,경기 화성시 양감면 신왕리 605-3,1등 당첨: 1회,1
행운복권방,경남 창원시 성산구 가음로15번길 52,경남 창원시 성산구 남양동 22,1등 당첨: 1회,1
꿈꾸는돼지,경기 화성시 동탄지성로 104,경기 화성시 반송동 42-2,1등 당첨: 1회,1
지에스(GS25)뉴양산혜인점,경남 양산시 웅상대로 955,경남 양산시 평산동 31-5,1등 당첨: 1회,1
씨스페이스 경주세방매점,경북 경주시 산업로 4447,경북 경주시 용강동 753-3,1등 당첨: 1회,1
도항로또,경남 함안군 함마대로 1499-1,경남 함안군 가야읍 도항리 321-6,1등 당첨: 1회,1
씨유 창원역점,경남 창원시 의창구 의창대로 66,경남 창원시 의창구 팔용동 157-3,1등 당첨: 1회,1
해수로또,충북 청주시 상당구 산성로 22-1 ,충북 청주시 상당구 금천동 185-12,1등 당첨: 1회,1
이마트24 마산만복점,경남 창원시 마산회원구 합성옛길 152,경남 창원시 마산회원구 합성동 266-17번지,1등 당첨: 1회,1
경일통신,경남 창원시 마산회원구 북성로 340,경남 창원시 마산회원구 회성동 169-1번지,1등 당첨: 1회,1
똥꿈로또,경남 진주시 신안로 102,경남 진주시 신안동 10-12,1등 당첨: 1회,1
수경볼트로또,경남 양산시 고연로 283,경남 양산시 용당동 974-1,1등 당첨: 1회,1
양산황금나눔,경남 양산시 황산로 395 ,경남 양산시 물금읍 물금리 406-73,1등 당첨: 1회,1
천하명당,경남 양산시 소주회야로 45-8 ,경남 양산시 소주동 409-2,1등 당첨: 1회,1
천하명당,경기 화성시 남양시장로 83 ,경기 화성시 남양읍 남양리 1267-5,1등 당첨: 1회,1
천하명당,경남 양산시 연호로 46 ,경남 양산시 삼호동 491-3,1등 당첨: 1회,1
스포츠복권방,경남 양산시 물금읍 황산로 675,경남 양산시 물금읍 범어리 386-1번지,1등 당첨: 1회,1
무지개로또복권,경남 양산시 덕계2길 17,경남 양산시 덕계동 1254,1등 당첨: 1회,1
비휴 복권판매점,경남 산청군 지리산대로 3474-1,경남 산청군 신안면 하정리 749-15,1등 당첨: 1회,1
목화휴게소,경남 사천시 사천대로 912 목화휴게소식당,경남 사천시 용현면 주문리 4,1등 당첨: 1회,1
아리아리,경남 김해시 김해대로2491번길 28,경남 김해시 삼정동 646-23,1등 당첨: 1회,1
씨유 (CU) 거창대동점,경남 거창군 거창읍 거창대로 93,경남 거창군 거창읍 대동리 702번지,1등 당첨: 1회,1
천하명당복권방,경남 거제시 옥포성안로 60,경남 거제시 옥포1동 582번지,1등 당첨: 1회,1
떴다GO 1등,경기 화성시 동탄반석로 172 동탄 파라곤,경기 화성시 반송동 93-3,1등 당첨: 1회,1
복권나라,충북 청주시 상당구 상당로 9,충북 청주시 상당구 남문로1가 137-2번지,1등 당첨: 1회,1
로또복권방,인천 부평구 광장로 16 부평민자역사,인천 부평구 부평동 738-21,1등 당첨: 1회,1
팡팡복권방,충북 진천군 장기길 102 ,충북 진천군 광혜원면 광혜원리 265-3,1등 당첨: 1회,1
홈돌이로또복권,인천 남동구 경원대로 971,인천 남동구 간석동 616-3번지,1등 당첨: 1회,1
행운복권방,인천 부평구 부평대로165번길 10,인천 부평구 부평동 798-4,1등 당첨: 1회,1
행운복권방,인천 부평구 경인로 745,인천 부평구 십정동 577-13,1등 당첨: 1회,1
행운복권방,인천 부평구 부평문화로163번길 1,인천 부평구 부개동 105-16,1등 당첨: 1회,1
충남상회,인천 미추홀구 참외전로 268,인천 미추홀구 숭의동 462,1등 당첨: 1회,1
한솔복권&마트,인천 미추홀구 경인로 384 ,인천 미추홀구 주안동 434-1,1등 당첨: 1회,1
노다지천국,인천 미추홀구 인주대로 185 ,인천 미추홀구 용현동 128-19,1등 당첨: 1회,1
동행로또복권판매,인천 동구 화도진로 33-1,인천 동구 송현동 98-220,1등 당첨: 1회,1
로또생삼겹,인천 남동구 논고개로 77 에코타워,인천 남동구 논현동 746-4,1등 당첨: 1회,1
로또 명당,인천 남동구 구월남로 271,인천 남동구 구월동 1271-24,1등 당첨: 1회,1
소래복권,인천 남동구 앵고개로934번길 5 씨티짱,인천 남동구 논현동 673-2,1등 당첨: 1회,1
선경로또,충북 제천시 용두대로 59 ,충북 제천시 하소동 188-1,1등 당첨: 1회,1
대동슈퍼,인천 남동구 만수로 81,인천 남동구 만수2동 5-200번지,1등 당첨: 1회,1
정가네 가람기정떡,인천 남동구 에코중앙로156번길 5-27 ,인천 남동구 논현동 772-4,1등 당첨: 1회,1
탑로또,인천 남동구 서창남로 81 투엠프라자,인천 남동구 서창동 686-2,1등 당첨: 1회,1
하나복권,인천 남동구 구월로 281,인천 남동구 만수5동 906-2번지,1등 당첨: 1회,1
알파슈퍼,인천 계양구 안남로 467,인천 계양구 효성동 331-6번지,1등 당첨: 1회,1
좋은터,인천 계양구 효서로 204 ,인천 계양구 효성동 195-19,1등 당첨: 1회,1
아이러브마트복권방,울산 중구 유곡로 19-1 ,울산 중구 태화동 22-25,1등 당첨: 1회,1
1등복권방,울산 울주군 동문길 84,울산 울주군 언양읍 남부리 253번지,1등 당첨: 1회,1
제이마트,울산 울주군 방천7길 6,울산 울주군 언양읍 서부리 246-3,1등 당첨: 1회,1
복권왕국,인천 부평구 동수로 168,인천 부평구 부개동 259-16번지,1등 당첨: 1회,1
복권왕국,인천 부평구 경인로 931 ,인천 부평구 부평동 709-1,1등 당첨: 1회,1
복권왕국,인천 부평구 부흥로 359 우편물취급국,인천 부평구 부평동 115-24,1등 당첨: 1회,1
대박운때복권방,인천 부평구 시장로 58,인천 부평구 부평동 150-4,1등 당첨: 1회,1
좋은사람들로또,전남 보성군 현충로 85 ,전남 보성군 보성읍 보성리 896-4,1등 당첨: 1회,1
토마토 남악복권방,전남 무안군 남악4로82번길 44 ,전남 무안군 삼향읍 남악리 1552,1등 당첨: 1회,1
청호복권방,전남 목포시 용당로 296 ,전남 목포시 용해동 353,1등 당첨: 1회,1
명품복권방,전남 목포시 섶나루길 122 ,전남 목포시 상동 799-10,1등 당첨: 1회,1
알리바이(나주점),전남 나주시 나주로 142,전남 나주시 금성동 2-2번지,1등 당첨: 1회,1
황금알복권,전남 광양시 광포로 39,전남 광양시 광영동 801-2,1등 당첨: 1회,1
나눔로또편의점,전남 광양시 공영로 90 ,전남 광양시 중동 1758-3,1등 당첨: 1회,1
이마트24녹동점1등복권방,전남 고흥군 녹동남촌1길 13,전남 고흥군 도양읍 봉암리 2699-255,1등 당첨: 1회,1
현대설비 / 영종하늘 로또,인천 중구 하늘달빛로 70,인천 중구 중산동 1875-12,1등 당첨: 1회,1
드림복권방,인천 연수구 아트센터대로168번길 100,인천 연수구 송도동 29-1,1등 당첨: 1회,1
신흥엑스포쇼핑,인천 서구 가석로156번길 20 ,인천 서구 가좌동 192-86,1등 당첨: 1회,1
대박복권방,인천 서구 길주로 106,인천 서구 석남동 544-34,1등 당첨: 1회,1
대박복권방,인천 서구 북항로32번안길 35,인천 서구 원창동 381-68,1등 당첨: 1회,1
대박복권방,인천 서구 대평로 3,인천 서구 심곡동 239-1번지,1등 당첨: 1회,1
하영,인천 서구 청라에메랄드로 65 서해그랑블,인천 서구 청라동 165-10,1등 당첨: 1회,1
노다지로또,인천 서구 완정로  179,인천 서구 왕길동 638-4,1등 당첨: 1회,1
웃는 복권방,경북 구미시 형곡로39길 3,경북 구미시 형곡동 186-4,1등 당첨: 1회,1
로또복권방,인천 부평구 마장로 287,인천 부평구 산곡동 182,1등 당첨: 1회,1
버스매표소,인천 부평구 부평대로 3,인천 부평구 부평동 549-39번지,1등 당첨: 1회,1
CU노서점,경북 경주시 금성로259번길 38,경북 경주시 노서동 178-12,1등 당첨: 1회,1
해피+24시편의점,광주 북구 하서로 330,광주 북구 양산동 296번지,1등 당첨: 1회,1
행운로또,경북 구미시 들성로 106,경북 구미시 고아읍 원호리 221-4,1등 당첨: 1회,1
두꺼비복권방,충남 공주시 무령로 599-25,충남 공주시 금흥동 632,1등 당첨: 1회,1
이마트24아산도고명당점,충남 아산시 온천대로 104,충남 아산시 도고면 금산리 161-21,1등 당첨: 1회,1
777천하명당,충남 서천군 충절로 54,충남 서천군 서천읍 군사리 684-5번지,1등 당첨: 1회,1
장미슈퍼,충남 부여군 부여읍 계백로 265,충남 부여군 부여읍 동남리 739-9번지,1등 당첨: 1회,1
찬누리,충남 부여군 사비로 61 ,충남 부여군 부여읍 동남리 709-2,1등 당첨: 1회,1
금손로또판매점,충남 당진시 서해로 5772,충남 당진시 읍내동 458,1등 당첨: 1회,1
로또매점,충남 당진시 송산로 723 ,충남 당진시 송산면 유곡리 355-36,1등 당첨: 1회,1
인생역전 복권방,충남 논산시 중앙로 168,충남 논산시 내동 145,1등 당첨: 1회,1
강경복권방,충남 논산시 강경읍 계백로 126-1,충남 논산시 강경읍 대흥리 19-3번지,1등 당첨: 1회,1
돈나무복권,충남 논산시 중앙로479번길 3-2,충남 논산시 반월동 161-17,1등 당첨: 1회,1
만복복권,충남 계룡시 엄사중앙로 93,충남 계룡시 엄사면 엄사리 184-4,1등 당첨: 1회,1
행복로또,충남 아산시 아산밸리남로 81,충남 아산시 둔포면 석곡리 1805,1등 당첨: 1회,1
씨유 제주연북로점,제주 제주시 연북로 260 ,제주 제주시 오라이동 1770-2,1등 당첨: 1회,1
효당복권판매점,제주 제주시 노형로 355,제주 제주시 노형동 2520-18,1등 당첨: 1회,1
제일복권,제주 제주시 서광로 257 ,제주 제주시 삼도일동 558-10,1등 당첨: 1회,1
본스튜디오,제주 제주시 하귀로 111 ,제주 제주시 애월읍 하귀1리 1550-10,1등 당첨: 1회,1
탐나네,제주 제주시 노연로 138,제주 제주시 연동 294-39,1등 당첨: 1회,1
캠퍼트리 스토어,제주 제주시 해안마을서4길 100,제주 제주시 해안동 2499-2,1등 당첨: 1회,1
천하명당복권판매점,제주 제주시 서해안로 510,제주 제주시 용담삼동 2318-3,1등 당첨: 1회,1
행운&빈센트,제주 서귀포시 동문로 64,제주 서귀포시 서귀동 256-2,1등 당첨: 1회,1
네잎크로버복권방,제주 서귀포시 고성오조로 9,제주 서귀포시 성산읍 고성리 1009-1,1등 당첨: 1회,1
대박마트복권방,충남 아산시 음봉로 844 행복한순복음교회,충남 아산시 음봉면 산동리 431-10,1등 당첨: 1회,1
내포복권방,충남 예산군 덕산온천로 387 ,충남 예산군 덕산면 신평리 344-3,1등 당첨: 1회,1
돈방석,전북 전주시 완산구 서신로 35,전북 전주시 완산구 서신동 831-3번지,1등 당첨: 1회,1
보은로또,충북 보은군 보은로 140-1 학원,충북 보은군 보은읍 삼산리 152-15,1등 당첨: 1회,1
세븐일레븐 중동현대점,경기 부천시 석천로183번길 35,경기 부천시 중동 1166-4,1등 당첨: 1회,1
도담복권,경기 부천시 역곡로 451 뉴월드맨션,경기 부천시 고강동 480-9,1등 당첨: 1회,1
풍전슈퍼,경기 부천시 조마루로 428,경기 부천시 원미동 55-1번지,1등 당첨: 1회,1
로또대박,경기 부천시 석천로177번길 11 제이클래스중동,경기 부천시 중동 1162-2,1등 당첨: 1회,1
버스매표소,경기 부천시 부천로 32,경기 부천시 심곡동 164-4번지,1등 당첨: 1회,1
버스매표소,경기 부천시 부천로 151,경기 부천시 심곡동 78-1번지,1등 당첨: 1회,1
원대박,충북 음성군 대금로 1064-20,충북 음성군 금왕읍 오선리 478-5,1등 당첨: 1회,1
혁신대박,충북 음성군 원중로 1434 ,충북 음성군 맹동면 동성리 489,1등 당첨: 1회,1
서울로또방,충북 옥천군 삼금로 8,충북 옥천군 옥천읍 금구리 142-8번지,1등 당첨: 1회,1
천하명당복권방,충남 홍성군 조양로 180 ,충남 홍성군 홍성읍 오관리 321-4,1등 당첨: 1회,1
GS25예산서오점복권,충남 예산군 역전로 150-2 ,충남 예산군 예산읍 산성리 704,1등 당첨: 1회,1
태안로또복권방,충남 태안군 독샘로 57 ,충남 태안군 태안읍 동문리 481-7,1등 당첨: 1회,1
안면대박복권방,충남 태안군 안면대로 2649,충남 태안군 안면읍 승언리 776-16,1등 당첨: 1회,1
대박로또,충남 천안시 서북구 성환2로 45 ,충남 천안시 서북구 성환읍 매주리 324-5,1등 당첨: 1회,1
신불당로또,충남 천안시 서북구 불당21로 40,충남 천안시 서북구 불당동 1613,1등 당첨: 1회,1
황금로또 양당점,충남 천안시 서북구 상덕로 185,충남 천안시 서북구 직산읍 양당리 5-75,1등 당첨: 1회,1
복동희로또 불당점,충남 천안시 서북구 불당5길 23,충남 천안시 서북구 불당동 1124,1등 당첨: 1회,1
운수대통복권방,충남 천안시 동남구 대흥로 122 ,충남 천안시 동남구 사직동 202-22,1등 당첨: 1회,1
대산슈퍼,충남 천안시 동남구 복구정3길 1 로단판매점,충남 천안시 동남구 북면 연춘리 120-5,1등 당첨: 1회,1
신천하명당,충남 예산군 발연로 1,충남 예산군 예산읍 발연리 324-2,1등 당첨: 1회,1
터미널복권방,전북 정읍시 연지8길 6,전북 정읍시 연지동 311-5번지,1등 당첨: 1회,1
로또로복권,전북 전주시 완산구 모악로 4729,전북 전주시 완산구 평화동2가 850-3,1등 당첨: 1회,1
로또안경콘택트,경북 구미시 구미중앙로5길 2,경북 구미시 원평동 109-20번지,1등 당첨: 1회,1
행복충전,경북 포항시 북구 삼흥로 441,경북 포항시 북구 흥해읍 남송리 743-5,1등 당첨: 1회,1
금호동,광주 서구 화개1로 63,광주 서구 금호동 239-3,1등 당첨: 1회,1
전대복권판매점,광주 북구 서양로 28,광주 북구 신안동 213-1,1등 당첨: 1회,1
열정복권,광주 북구 하남대로 821,광주 북구 운암동 412-10,1등 당첨: 1회,1
행운가득명당복권,울산 울주군 점촌5길 23,울산 울주군 범서읍 구영리 816-15,1등 당첨: 1회,1
노다지복권방백운점,광주 남구 서문대로 827,광주 남구 주월동 1333,1등 당첨: 1회,1
호반할인마트,광주 광산구 도산로9번길 40,광주 광산구 도산동 1295-8번지,1등 당첨: 1회,1
행운,광주 광산구 신창로 56 ,광주 광산구 신창동 1215-2,1등 당첨: 1회,1
차밍플라워 로또,광주 광산구 풍영로 41,광주 광산구 월곡동 683-3번지,1등 당첨: 1회,1
포항오거리CU복권 ,경북 포항시 북구 죽도로 33,경북 포항시 북구 죽도동 42-17,1등 당첨: 1회,1
경이네복권마트 ,경북 포항시 북구 장량중앙로 81 ,경북 포항시 북구 양덕동 651-1,1등 당첨: 1회,1
로또복권,대구 군위군 중앙길 32,대구 군위군 군위읍 서부리 124-6,1등 당첨: 1회,1
지에스GS오천두배점,경북 포항시 남구 원동로 98,경북 포항시 남구 오천읍 원리 1187,1등 당첨: 1회,1
일등복권,경북 칠곡군 동명면 금암중앙길 42,경북 칠곡군 동명면 금암리 231-48번지,1등 당첨: 1회,1
복권명당울진점,경북 울진군 울진읍 울진중앙로 79,경북 울진군 울진읍 읍내리 435-10번지,1등 당첨: 1회,1
대동도기상사,경북 영천시 금완로 30,경북 영천시 금노동 499-3번지,1등 당첨: 1회,1
일등로또복권 판매점,경북 영천시 완산로 23-1,경북 영천시 완산동 909-4,1등 당첨: 1회,1
복권당,경북 영천시 강변로 60 ,경북 영천시 금노동 544-31,1등 당첨: 1회,1
홈런복권방,경북 영덕군 영덕읍 남석길 57,경북 영덕군 영덕읍 남석리 52-10번지,1등 당첨: 1회,1
왕대박복권방,경북 문경시 중앙로 15,경북 문경시 모전동 81-89번지,1등 당첨: 1회,1
팔팔복권,경북 김천시 시청로 81,경북 김천시 신음동 989-2,1등 당첨: 1회,1
새상무복권,광주 서구 치평로 30 ,광주 서구 치평동 1178-1,1등 당첨: 1회,1
다다복권방,대구 달서구 월배로 32-1,대구 달서구 진천동 652-4,1등 당첨: 1회,1
로또편의점,전북 전주시 덕진구 기린대로 469 ,전북 전주시 덕진구 덕진동1가 1267-18,1등 당첨: 1회,1
알짜마트왕지점,전남 순천시 왕궁길 60,전남 순천시 조례동 1804번지,1등 당첨: 1회,1
로또편의점,전북 전주시 덕진구 아중로 173,전북 전주시 덕진구 인후동1가 920-5번지,1등 당첨: 1회,1
복조리복권방,전북 장수군 장계면 장계천변길 55-4,전북 장수군 장계면 장계리 351-8번지,1등 당첨: 1회,1
여기있었네복권방,전북 김제시 남북로 171,전북 김제시 요촌동 474-3번지,1등 당첨: 1회,1
돈나무 복권,전북 군산시 공단대로 612,전북 군산시 소룡동 1536-9,1등 당첨: 1회,1
씨유 군산디오션점,전북 군산시 궁포1로 42,전북 군산시 조촌동 2-38,1등 당첨: 1회,1
터미널,전남 진도군 남문길 5,전남 진도군 진도읍 남동리 782-1,1등 당첨: 1회,1
영광믿음복권,전남 영광군 신남로 169,전남 영광군 영광읍 단주리 630-13,1등 당첨: 1회,1
복권나라,전남 여수시 중앙로 62,전남 여수시 교동 448-2번지,1등 당첨: 1회,1
중앙복권,전남 신안군 구영2길 74,전남 신안군 자은면 구영리 126-7,1등 당첨: 1회,1
이마트24 순천산단점,"전남 순천시 산단1길 6 중앙정밀기계,마트",전남 순천시 서면 선평리 300-2,1등 당첨: 1회,1
상인명당복권방,대구 달서구 조암남로16길 19,대구 달서구 월성동 1557-6,1등 당첨: 1회,1
메트로센터점,대구 중구 달구벌대로 지하 2100,대구 중구 덕산동 88번지,1등 당첨: 1회,1
홀인원복권,대구 수성구 달구벌대로 3294 시지퍼스트,대구 수성구 신매동 267,1등 당첨: 1회,1`;

    const records = parse(manualData, {
        columns: false,
        skip_empty_lines: true,
        trim: true
    });

    const storeList = records.map(record => ({
        name: record[0],
        address: record[1],
        winCount1st: parseInt(record[4], 10) || 0
    }));

    console.log(`Total stores to process: ${storeList.length}`);

    const tasks = storeList.map(store => async () => {
        const geo = await geocode(store.address);
        if (geo) {
            return {
                id: store.name.replace(/\s+/g, '-'),
                name: store.name,
                address: store.address,
                lat: geo.lat,
                lng: geo.lng,
                type: ['LOTTO'],
                winCount1st: store.winCount1st,
                winCount2nd: 0
            };
        }
        return null;
    });

    const processedStores = (await processBatch(tasks, CONCURRENCY_LIMIT)).filter(s => s !== null);
    
    // 최종 결과 저장
    const output = `
import { LotteryStore, StoreType } from './types';

export const MOCK_STORES: LotteryStore[] = ${JSON.stringify(processedStores, null, 2)};
`;

    fs.writeFileSync('lib/data.ts', output);
    saveCache();
    console.log(`Successfully processed ${processedStores.length} stores.`);
}

main().catch(console.error);
